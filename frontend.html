<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>图书馆座位占用模拟系统</title>
    <style>
        body {
            font-family: 'Arial', sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f5f5f5;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            padding: 20px;
        }
        
        .header {
            text-align: center;
            margin-bottom: 20px;
        }
        
        .controls {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            margin-bottom: 20px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 5px;
        }
        
        .control-group {
            display: flex;
            flex-direction: column;
            min-width: 200px;
        }
        
        .control-group label {
            margin-bottom: 5px;
            font-weight: bold;
        }
        
        .control-group input[type="range"] {
            width: 100%;
        }
        
        .language-toggle {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .simulation-area {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }
        
        .library-grid {
            display: grid;
            grid-template-columns: repeat(20, 25px);
            gap: 2px;
            justify-content: center;
            background: #e9ecef;
            padding: 10px;
            border-radius: 5px;
            margin-bottom: 20px;
        }
        
        .seat {
            width: 24px;
            height: 24px;
            border: 1px solid #6c757d;
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 8px;
            cursor: pointer;
        }
        
        .seat.vacant {
            background-color: #d4edda; /* 空闲 - 浅绿色 */
        }
        
        .seat.taken {
            background-color: #cce5ff; /* 已占用 - 浅蓝色 */
        }
        
        .seat.reverse {
            background-color: #fff3cd; /* 占座 - 浅黄色 */
        }
        
        .seat.signed {
            background-color: #f8d7da; /* 标记清理 - 浅红色 */
        }
        
        .seat-attribute {
            position: absolute;
            font-size: 6px;
            color: #495057;
        }
        
        .seat-attribute.lamp {
            top: 1px;
            left: 1px;
        }
        
        .seat-attribute.socket {
            bottom: 1px;
            right: 1px;
        }
        
        .seat-attribute.window {
            top: 1px;
            right: 1px;
        }
        
        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .stat-card {
            background: #e9ecef;
            padding: 15px;
            border-radius: 5px;
            text-align: center;
        }
        
        .stat-value {
            font-size: 24px;
            font-weight: bold;
            color: #007bff;
        }
        
        .stat-label {
            font-size: 14px;
            color: #6c757d;
        }
        
        .chart-container {
            height: 300px;
            margin-top: 20px;
            border: 1px solid #dee2e6;
            border-radius: 5px;
            padding: 10px;
        }
        
        .legend {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-top: 10px;
            flex-wrap: wrap;
        }
        
        .legend-item {
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .legend-color {
            width: 15px;
            height: 15px;
            border: 1px solid #6c757d;
        }
        
        .legend-vacant { background-color: #d4edda; }
        .legend-taken { background-color: #cce5ff; }
        .legend-reverse { background-color: #fff3cd; }
        .legend-signed { background-color: #f8d7da; }
        
        .legend-lamp { color: #856404; }
        .legend-socket { color: #0c5460; }
        .legend-window { color: #721c24; }
        
        .button-group {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }
        
        button {
            padding: 8px 16px;
            border: none;
            border-radius: 4px;
            background-color: #007bff;
            color: white;
            cursor: pointer;
        }
        
        button:hover {
            background-color: #0056b3;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>图书馆座位占用行为模拟系统</h1>
        </div>
        
        <div class="controls">
            <div class="control-group">
                <label for="language">语言选择</label>
                <select id="language">
                    <option value="zh">中文</option>
                    <option value="en">English</option>
                </select>
            </div>
            
            <div class="control-group">
                <label for="simulation-mode">模拟模式</label>
                <select id="simulation-mode">
                    <option value="new">创建新模拟</option>
                    <option value="replay">复现旧模拟</option>
                </select>
            </div>
            
            <div class="control-group">
                <label for="student-count">学生数量: <span id="student-count-value">200</span></label>
                <input type="range" id="student-count" min="50" max="500" step="10" value="200">
            </div>
            
            <div class="control-group">
                <label for="lamp-preference">台灯偏好: <span id="lamp-preference-value">60</span>%</label>
                <input type="range" id="lamp-preference" min="0" max="100" value="60">
            </div>
            
            <div class="control-group">
                <label for="socket-preference">插座偏好: <span id="socket-preference-value">30</span>%</label>
                <input type="range" id="socket-preference" min="0" max="100" value="30">
            </div>
            
            <div class="control-group">
                <label for="space-preference">空旷偏好: <span id="space-preference-value">10</span>%</label>
                <input type="range" id="space-preference" min="0" max="100" value="10">
            </div>
            
            <div class="control-group">
                <label for="check-time">检查时间: <span id="check-time-value">1.0</span>小时</label>
                <input type="range" id="check-time" min="0.5" max="5" step="0.5" value="1">
            </div>
            
            <div class="control-group">
                <label for="clear-time">清理时间: <span id="clear-time-value">2.0</span>小时</label>
                <input type="range" id="clear-time" min="0.5" max="5" step="0.5" value="2">
            </div>
        </div>
        
        <div class="button-group">
            <button id="start-btn">开始模拟</button>
            <button id="pause-btn">暂停模拟</button>
            <button id="reset-btn">重置模拟</button>
        </div>
        
        <div class="simulation-area">
            <h3>图书馆座位状态</h3>
            <div class="library-grid" id="library-grid">
                <!-- 座位网格将通过JavaScript生成 -->
            </div>
            
            <div class="legend">
                <div class="legend-item">
                    <div class="legend-color legend-vacant"></div>
                    <span>空闲</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color legend-taken"></div>
                    <span>已占用</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color legend-reverse"></div>
                    <span>占座</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color legend-signed"></div>
                    <span>标记清理</span>
                </div>
                <div class="legend-item">
                    <span class="legend-lamp">L</span>
                    <span>台灯</span>
                </div>
                <div class="legend-item">
                    <span class="legend-socket">S</span>
                    <span>插座</span>
                </div>
                <div class="legend-item">
                    <span class="legend-window">W</span>
                    <span>靠窗</span>
                </div>
            </div>
            
            <div class="stats">
                <div class="stat-card">
                    <div class="stat-value" id="occupancy-rate">0%</div>
                    <div class="stat-label">座位被占率</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="reverse-rate">0%</div>
                    <div class="stat-label">占座率</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="unsatisfied-rate">0%</div>
                    <div class="stat-label">学生不满率</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="total-seats">400</div>
                    <div class="stat-label">总座位数</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="current-time">07:00</div>
                    <div class="stat-label">当前时间</div>
                </div>
            </div>
            
            <h3>模拟数据可视化</h3>
            <div class="chart-container">
                <canvas id="stats-chart" width="1000" height="250"></canvas>
            </div>
        </div>
    </div>

    <script>
        // API基础URL
        const API_BASE_URL = 'http://127.0.0.1:5000';
        
        // 全局变量
        let simulationRunning = false;
        let updateInterval = null;
        
        // 从后端获取座位数据
        async function fetchSeats() {
            try {
                const response = await fetch(`${API_BASE_URL}/api/seats`);
                const data = await response.json();
                
                if (data.status === 'error') {
                    console.error('获取座位数据失败:', data.message);
                    return [];
                }
                
                return data.seats;
            } catch (error) {
                console.error('获取座位数据时发生错误:', error);
                return [];
            }
        }
        
        // 从后端获取统计数据
        async function fetchStats() {
            try {
                const response = await fetch(`${API_BASE_URL}/api/stats`);
                const data = await response.json();
                
                if (data.status === 'error') {
                    console.error('获取统计数据失败:', data.message);
                    return null;
                }
                
                return data;
            } catch (error) {
                console.error('获取统计数据时发生错误:', error);
                return null;
            }
        }
        
        // 渲染座位网格
        async function renderSeats() {
            const seats = await fetchSeats();
            if (!seats || seats.length === 0) return;
            
            const grid = document.getElementById('library-grid');
            grid.innerHTML = '';
            
            // 重新排列座位到20x20网格
            for (let x = 0; x < 20; x++) {
                for (let y = 0; y < 20; y++) {
                    const seat = seats.find(s => s.x === x && s.y === y);
                    const seatElement = document.createElement('div');
                    
                    if (seat) {
                        seatElement.className = `seat ${seat.status}`;
                        seatElement.title = `座位 (${seat.x}, ${seat.y}) - 状态: ${getStatusText(seat.status)}`;
                        
                        // 添加附属信息标识
                        if (seat.lamp) {
                            const lampIcon = document.createElement('div');
                            lampIcon.className = 'seat-attribute lamp';
                            lampIcon.textContent = 'L';
                            lampIcon.title = '台灯';
                            seatElement.appendChild(lampIcon);
                        }
                        
                        if (seat.socket) {
                            const socketIcon = document.createElement('div');
                            socketIcon.className = 'seat-attribute socket';
                            socketIcon.textContent = 'S';
                            socketIcon.title = '插座';
                            seatElement.appendChild(socketIcon);
                        }
                        
                        if (seat.window) {
                            const windowIcon = document.createElement('div');
                            windowIcon.className = 'seat-attribute window';
                            windowIcon.textContent = 'W';
                            windowIcon.title = '靠窗';
                            seatElement.appendChild(windowIcon);
                        }
                    } else {
                        // 如果没有找到对应座位，创建一个空座位元素
                        seatElement.className = 'seat vacant';
                        seatElement.title = `座位 (${x}, ${y}) - 空位`;
                    }
                    
                    grid.appendChild(seatElement);
                }
            }
        }
        
        // 获取状态文本
        function getStatusText(status) {
            const statusMap = {
                'vacant': '空闲',
                'taken': '已占用',
                'reverse': '占座',
                'signed': '标记清理'
            };
            return statusMap[status] || status;
        }
        
        // 更新统计数据
        async function updateStats() {
            const stats = await fetchStats();
            if (!stats) return;
            
            document.getElementById('occupancy-rate').textContent = `${stats.occupancy_rate}%`;
            document.getElementById('reverse-rate').textContent = `${stats.reverse_rate}%`;
            document.getElementById('unsatisfied-rate').textContent = `${stats.unsatisfied_rate}%`;
            document.getElementById('total-seats').textContent = stats.total_seats;
            document.getElementById('current-time').textContent = stats.current_time;
        }
        
        // 启动模拟
        async function startSimulation() {
            // 获取控制面板中的参数
            const studentCount = parseInt(document.getElementById('student-count').value);
            const lampPreference = parseInt(document.getElementById('lamp-preference').value) / 100;
            const socketPreference = parseInt(document.getElementById('socket-preference').value) / 100;
            const spacePreference = parseInt(document.getElementById('space-preference').value) / 100;
            
            // 计算人文和科学学生比例
            const humanitiesRate = 0.3; // 默认值
            const scienceRate = 0.3; // 默认值
            
            try {
                const response = await fetch(`${API_BASE_URL}/api/start`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        row: 20,
                        column: 20,
                        num_students: studentCount,
                        humanities_rate: humanitiesRate,
                        science_rate: scienceRate
                    })
                });
                
                const data = await response.json();
                
                if (data.status === 'success') {
                    simulationRunning = true;
                    document.getElementById('start-btn').textContent = '运行中...';
                    document.getElementById('start-btn').disabled = true;
                    
                    console.log('模拟启动成功:', data.message);
                    
                    // 开始定期更新数据
                    if (updateInterval) {
                        clearInterval(updateInterval);
                    }
                    updateInterval = setInterval(updateSimulationData, 2000); // 每2秒更新一次
                } else {
                    console.error('启动模拟失败:', data.message);
                }
            } catch (error) {
                console.error('启动模拟时发生错误:', error);
            }
        }
        
        // 执行一步模拟
        async function stepSimulation() {
            if (!simulationRunning) return;
            
            try {
                const response = await fetch(`${API_BASE_URL}/api/step`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });
                
                const data = await response.json();
                
                if (data.status === 'error') {
                    console.error('执行模拟步骤失败:', data.message);
                }
            } catch (error) {
                console.error('执行模拟步骤时发生错误:', error);
            }
        }
        
        // 暂停模拟
        async function pauseSimulation() {
            try {
                const response = await fetch(`${API_BASE_URL}/api/control`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        action: 'pause'
                    })
                });
                
                const data = await response.json();
                
                if (data.status === 'success') {
                    simulationRunning = false;
                    if (updateInterval) {
                        clearInterval(updateInterval);
                        updateInterval = null;
                    }
                    document.getElementById('start-btn').textContent = '开始模拟';
                    document.getElementById('start-btn').disabled = false;
                    
                    console.log('模拟已暂停:', data.message);
                } else {
                    console.error('暂停模拟失败:', data.message);
                }
            } catch (error) {
                console.error('暂停模拟时发生错误:', error);
            }
        }
        
        // 重置模拟
        async function resetSimulation() {
            try {
                const response = await fetch(`${API_BASE_URL}/api/control`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        action: 'reset'
                    })
                });
                
                const data = await response.json();
                
                if (data.status === 'success') {
                    simulationRunning = false;
                    if (updateInterval) {
                        clearInterval(updateInterval);
                        updateInterval = null;
                    }
                    document.getElementById('start-btn').textContent = '开始模拟';
                    document.getElementById('start-btn').disabled = false;
                    
                    // 重新渲染空座位
                    await renderSeats();
                    await updateStats();
                    
                    console.log('模拟已重置:', data.message);
                } else {
                    console.error('重置模拟失败:', data.message);
                }
            } catch (error) {
                console.error('重置模拟时发生错误:', error);
            }
        }
        
        // 更新模拟数据
        async function updateSimulationData() {
            if (simulationRunning) {
                await renderSeats();
                await updateStats();
            }
        }
        
        // 设置占座时间限制
        async function setLimitTime() {
            const checkTime = document.getElementById('check-time').value;
            const clearTime = document.getElementById('clear-time').value;
            
            // 使用较大的值作为限制时间
            const timeLimit = parseFloat(clearTime);
            const hours = Math.floor(timeLimit);
            const minutes = Math.round((timeLimit - hours) * 60);
            const timeLimitStr = `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}`;
            
            try {
                const response = await fetch(`${API_BASE_URL}/api/set_limit`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        time_limit: timeLimitStr
                    })
                });
                
                const data = await response.json();
                
                if (data.status === 'error') {
                    console.error('设置时间限制失败:', data.message);
                }
            } catch (error) {
                console.error('设置时间限制时发生错误:', error);
            }
        }
        
        // 事件监听器
        document.getElementById('student-count').addEventListener('input', function() {
            document.getElementById('student-count-value').textContent = this.value;
        });
        
        document.getElementById('lamp-preference').addEventListener('input', function() {
            document.getElementById('lamp-preference-value').textContent = this.value;
        });
        
        document.getElementById('socket-preference').addEventListener('input', function() {
            document.getElementById('socket-preference-value').textContent = this.value;
        });
        
        document.getElementById('space-preference').addEventListener('input', function() {
            document.getElementById('space-preference-value').textContent = this.value;
        });
        
        document.getElementById('check-time').addEventListener('input', function() {
            document.getElementById('check-time-value').textContent = this.value;
        });
        
        document.getElementById('clear-time').addEventListener('input', function() {
            document.getElementById('clear-time-value').textContent = this.value;
        });
        
        document.getElementById('start-btn').addEventListener('click', function() {
            if (!simulationRunning) {
                startSimulation();
            }
        });
        
        document.getElementById('pause-btn').addEventListener('click', function() {
            pauseSimulation();
        });
        
        document.getElementById('reset-btn').addEventListener('click', function() {
            resetSimulation();
        });
        
        // 初始化应用
        async function initApp() {
            // 初始渲染座位和统计数据
            await renderSeats();
            await updateStats();
            
            // 初始化图表
            initChart();
        }
        
        // 初始化图表
        function initChart() {
            const canvas = document.getElementById('stats-chart');
            const ctx = canvas.getContext('2d');
            
            // 清空画布
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            // 绘制简单的图表背景
            ctx.fillStyle = '#f8f9fa';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            
            // 绘制网格线
            ctx.strokeStyle = '#dee2e6';
            ctx.lineWidth = 1;
            
            // 水平线
            for (let i = 0; i <= 10; i++) {
                const y = i * (canvas.height / 10);
                ctx.beginPath();
                ctx.moveTo(0, y);
                ctx.lineTo(canvas.width, y);
                ctx.stroke();
            }
            
            // 垂直线
            for (let i = 0; i <= 10; i++) {
                const x = i * (canvas.width / 10);
                ctx.beginPath();
                ctx.moveTo(x, 0);
                ctx.lineTo(x, canvas.height);
                ctx.stroke();
            }
            
            // 绘制示例数据线
            ctx.strokeStyle = '#007bff';
            ctx.lineWidth = 2;
            ctx.beginPath();
            
            const dataPoints = [];
            for (let i = 0; i <= 20; i++) {
                const x = i * (canvas.width / 20);
                // 生成模拟数据 - 随机但有一定趋势
                const y = canvas.height - (Math.sin(i * 0.5) * 80 + 100) - Math.random() * 30;
                if (i === 0) {
                    ctx.moveTo(x, y);
                } else {
                    ctx.lineTo(x, y);
                }
                dataPoints.push({x, y});
            }
            
            ctx.stroke();
            
            // 添加标签
            ctx.fillStyle = '#495057';
            ctx.font = '12px Arial';
            ctx.fillText('座位占用率', 10, 20);
            
            // X轴标签 (时间)
            ctx.fillStyle = '#6c757d';
            ctx.font = '10px Arial';
            for (let i = 0; i <= 10; i++) {
                const time = 7 + i * 1.7; // 映射为7点到24点
                const hour = Math.floor(time);
                const minute = Math.round((time - hour) * 60);
                const timeStr = `${hour.toString().padStart(2, '0')}:${minute.toString().padStart(2, '0')}`;
                const x = i * (canvas.width / 10);
                ctx.fillText(timeStr, x, canvas.height - 5);
            }
        }
        
        // 页面加载完成后初始化
        window.onload = async function() {
            await initApp();
        };
    </script>
</body>
</html>