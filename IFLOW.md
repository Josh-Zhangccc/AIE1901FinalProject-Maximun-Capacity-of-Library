# AIE1901 期末考试模拟项目

## 项目概述

这是一个基于Python的图书馆座位占用行为模拟系统，旨在研究学生占座行为与图书馆管理措施对空间利用率和图书馆最大动态容量之间的关系。项目使用DeepSeek的LLM API来模拟学生行为，包含后端Python代码。

项目核心功能：
- 模拟图书馆环境（支持自定义网格大小，默认3x3网格，9个座位作为演示，可扩展到更大规模）
- 模拟学生基于个人作息、课程表和座位偏好的行为
- 管理座位状态（空闲、占用、占座、标记清理）
- 基于时间限制清理违规占座
- 支持模拟数据的保存与复现功能
- 提供参数调节功能和交互式命令行界面
- 实现模拟数据的可视化分析功能

## 项目结构

```
AIE1901_FinalExamSimulation/
├── backend/                 # 后端代码
│   ├── __init__.py         # 包初始化文件
│   ├── agents.py           # LLM客户端，用于与DeepSeek API交互
│   ├── json_manager.py     # JSON文件管理器，用于模拟数据的保存和读取
│   ├── library.py          # 图书馆类，管理座位和学生初始化
│   ├── plot.py             # 数据可视化模块，生成模拟数据图表
│   ├── prompt.py           # 各种LLM提示词模板
│   ├── seats.py            # 座位类，管理座位状态和属性
│   ├── simulation.py       # 模拟主类，协调整个模拟过程
│   ├── students.py         # 学生类，模拟学生行为
│   └── test/               # 测试目录
│       ├── __init__.py     # 包初始化文件
│       ├── test_interactions.py # 座位、学生和图书馆交互测试
│       ├── test_prompt.py  # 提示词功能测试
│       ├── test_seats.py   # 座位类单元测试
│       └── test_students.py # 学生类单元测试
├── simulation_data/        # 模拟数据存储目录
│   ├── figures/            # 存储可视化图表
│   ├── simulations/        # 存储模拟数据的JSON文件
│   └── test/              # 存储测试模拟数据
├── config.py              # 项目配置文件，包含路径配置
├── IFLOW.md               # 项目说明文档
├── main.py                # 主程序入口
├── problem_check.py       # 问题检查脚本
├── seat_simulation_env.yml # Conda环境配置文件
├── test_plot.py           # 可视化功能测试脚本
├── utils.py               # 工具函数，包含API配置
└── 要求.txt              # 项目需求文档
```

## 技术栈

- **后端**: Python 3.13.9
- **LLM API**: DeepSeek (通过OpenAI包调用)
- **依赖管理**: Conda
- **HTTP Client**: OpenAI Python Package
- **数据可视化**: matplotlib, pandas
- **其他库**: datetime, enum, random等标准库

## 核心组件

### JSON管理器 (json_manager.py)
- 提供JsonManager类，实现JSON文件的初始化和基本的结构创建、读写操作
- 支持多种文件格式检测（JSON、Pickle、Gzip压缩的JSON）
- 用于模拟数据的保存与复现功能

### 配置管理器 (config.py)
- 定义模拟数据文件的存储路径
- 提供统一的路径管理，便于项目维护

### 座位系统 (seats.py)
- 座位状态：空闲(vacant)、占用(taken)、占座(reverse)、标记清理(signed) - 使用Status枚举
- 座位属性：坐标(x, y)、是否有台灯(lamp)、插座(socket)、是否靠窗(window)
- 功能：占用、离开(完全/占座)、标记占座、清理超时占座、时间更新、满意度计算、拥挤参数计算
- 实现了完整的单元测试，确保状态转换逻辑正确
- 时间更新步长为15分钟（与图书馆系统同步）

### 学生系统 (students.py)
- 使用LLM客户端模拟学生行为
- 学生属性：个人性格(守序/利己)、作息偏好(早鸟/正常/晚)、专注度(高/中/低)、课程情况(多/中/少)、座位偏好
- 行为逻辑：选择座位、状态改变(离开/回座)、是否占座
- 包含状态枚举(SLEEP, LEARNING, AWAY, GONE) - 使用StudentState枚举
- 支持创建不同专业(文科/理科/工科)和不同学习程度(勤奋/中等/懒惰)的学生
- 根据座位满意度和图书馆规则决定占座行为
- 通过LLM生成动态日程表
- 时间更新步长为15分钟（与图书馆系统同步）
- 提供工厂方法批量创建不同类型学生，包括：
  - 勤奋学生：高专注度、高规则性
  - 中等学生：平衡各项指标
  - 懒惰学生：低专注度、低规则性
  - 按专业分类：文科、理科、工科学生各有不同的座位偏好

### LLM客户端 (agents.py)
- 基于DeepSeek API的客户端实现
- 使用OpenAI Python包与DeepSeek API交互
- 使用预设提示词与LLM交互
- 支持JSON格式响应解析
- 包含错误处理和JSON解析功能

### 图书馆系统 (library.py)
- 支持自定义网格大小的座位初始化（演示时使用3x3网格，可扩展至更大规模）
- 随机分配台灯、插座属性，边缘座位自动为靠窗座位
- 管理学生初始化，支持不同专业(人文、科学、工程)和学习程度(勤奋、中等、懒惰)的学生
- 实现座位清理机制(标记占座、清理超时占座)
- 计算座位拥挤参数，统计图书馆利用率
- 时间更新步长为15分钟
- 包含清理超时占座逻辑和标记机制
- 支持动态设置占座时间限制
- 提供座位状态可视化功能
- 实现座位拥挤参数计算，考虑周围座位占用情况

### 数据可视化系统 (plot.py)
- 提供数据解析功能，从JSON模拟数据中提取时间序列
- 实现三张核心图表的绘制：
  1. 座位占有率和占座率随时间变化图
  2. 不满意数及清理座位数随时间变化图
  3. 图书馆座位拥挤程度与归一化占有率对比图
- 支持中文标签显示
- 包含复杂的拥挤度计算算法，考虑了实际用户体验
- 提供测试脚本test_plot.py用于验证功能

### 模拟框架 (simulation.py)
- 协调图书馆、学生和座位系统
- 管理模拟时间流
- 提供交互式命令行界面，支持 step, status, seats, time, set_limit, quit, help 命令
- 支持自定义模拟参数（网格大小、学生数量、专业比例等）
- 实现了实时的模拟状态查看和参数调整功能
- 集成JSON管理器，实现模拟数据的自动保存

## 环境配置

使用Conda创建指定环境：
```bash
conda env create -f seat_simulation_env.yml
```

环境包含必要的Python包，如Flask、Flask-CORS、OpenAI、httpx、pydantic、matplotlib、pandas等。

## API配置

在`utils.py`中配置DeepSeek API：
- `BASE_URL`: https://api.deepseek.com
- `API_KEY`: sk-cf8230f3e78a4cedadf7f7ab158f5441
- `MODEL`: deepseek-chat

### 运行方式

当前运行方式：
```bash
# 激活conda环境
conda activate seat-simulation

# 运行主程序（默认使用较小规模进行演示）
python main.py
```

运行后会自动显示可视化结果。

## 测试

项目包含多种测试，位于`backend/test/`目录下：
- `test_seats.py`: 座位类的完整单元测试，覆盖所有状态转换场景
- `test_prompt.py`: 提示词功能测试
- `test_students.py`: 学生类的完整单元测试，覆盖学生行为的各种场景
- `test_interactions.py`: 座位、学生和图书馆之间交互的综合测试
  - 测试学生与座位的基本交互
  - 测试占座行为
  - 测试图书馆的占座标记和清理系统
  - 测试基于学生日程的交互
  - 测试座位舒适度和拥挤度计算
  - 测试图书馆座位计数功能
- `problem_check.py`: 项目问题检查脚本，包含多项测试
- `test_plot.py`: 可视化功能测试脚本

运行测试：
```bash
python -m pytest backend/test/
# 或运行特定测试
python backend/test/test_seats.py
python backend/test/test_students.py
python backend/test/test_interactions.py
python problem_check.py  # 根目录的问题检查脚本
python test_plot.py      # 可视化功能测试
```

## 模拟特性

- **时间系统**: 模拟一天(7:00-24:00)，图书馆时间更新步长为15分钟，学生时间更新步长也为15分钟
- **学生行为**: 基于课程表、作息和满意度的智能决策
- **数据记录**: 记录每次更新的数据以支持模拟复现，已实现
- **参数调节**: 用户可调节网格大小、学生数量、专业比例、座位偏好、检查清理时间等参数
- **座位初始化**: 支持自定义网格大小的座位，随机分配台灯、插座属性，边缘座位为靠窗座位
- **座位状态管理**: 包括占用时间跟踪和状态转换
- **学生类型**: 支持3种专业(人文、科学、工程)和3种学习程度(勤奋/中等/懒惰)的学生，共9种不同类型的学生
- **交互测试**: 包含综合交互测试，验证系统各组件间的协作关系
- **交互式命令行界面**: 支持实时查看模拟状态、座位概览和调整时间限制
- **数据持久化**: 模拟数据自动保存到simulation_data目录中
- **数据可视化**: 自动生成三张分析图表，展示模拟结果的关键指标

## 提示词系统 (prompt.py)

包含两个主要的LLM提示词模板：
- `schedule_prompt`: 根据学生特征生成日程表，包含start、learn、eat、course、rest、end六种行为
- `leave_prompt`: 根据学生性格和满意度判断是否占座，包含action和reason字段

## 前端功能（计划中）

- 中英文语言选择
- 创建新模拟/复现旧模拟
- 滑块调节网格大小、学生数量、座位偏好、检查和清理时间
- 图书馆座位可视化显示
- 模拟数据可视化图表，支持多种可隐藏的图表

## 项目状态

目前项目架构已建立，包含完整的座位管理系统、学生系统、LLM客户端和提示词系统。测试用例已实现，特别是座位系统、学生系统和交互测试覆盖了各种场景。图书馆系统已实现基本功能，包括座位初始化、学生初始化和管理功能。模拟框架提供了交互式命令行界面，支持参数调节和实时监控。JSON管理器实现了模拟数据的保存与复现功能。新增了数据可视化功能，可以生成分析图表。

**已完成部分：**
- 核心模拟系统
- 座位状态管理
- 学生行为模拟
- LLM集成
- 交互式界面
- 测试系统
- 模拟数据保存功能
- 数据可视化功能

**待完善部分：**
- 前端界面需要开发
- 完整的模拟流程优化
- 性能优化（如解决Library初始化时可能导致的长时间延迟问题）